<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Management | RCDNET</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Previous styles remain the same, add these new styles */

        /* Budget Table Styles */
        .budget-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .budget-table th, 
        .budget-table td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }

        .budget-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .budget-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .budget-table tr:hover {
            background-color: #f1f1f1;
        }

        .budget-total {
            font-weight: bold;
            text-align: right;
            padding: 10px;
            background-color: #f8f9fa;
            border-top: 2px solid #ddd;
        }

        /* Budget Form Styles */
        .budget-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .budget-form .form-group {
            flex: 1;
            min-width: 200px;
        }

        .budget-form .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .budget-form .form-group input,
        .budget-form .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .budget-form .form-actions {
            display: flex;
            align-items: flex-end;
        }

        /* Budget Section */
        .budget-section {
            margin-top: 30px;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .budget-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .budget-form .form-group {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <main class="main-content">
            <h1 class="page-title">
                <i class="fas fa-project-diagram"></i>
                Project Management
            </h1>

            <div class="projects-container">
                <div class="section-header">
                    <h2 class="section-title">Current Projects</h2>
                    <div class="section-actions">
                        <button class="btn" id="createProjectBtn">
                            <i class="fas fa-plus"></i> New Project
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="projects-table" id="projectsTable">
                        <thead>
                            <tr>
                                <th>Program Area</th>
                                <th>Project Name</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Budget (UGX)</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="projectsTableBody">
                            <!-- Projects will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Budget Section (visible when viewing a project) -->
            <div class="budget-section" id="budgetSection" style="display: none;">
                <div class="budget-section-header">
                    <h2 class="section-title">Project Budget</h2>
                    <button class="btn" id="addBudgetItemBtn">
                        <i class="fas fa-plus"></i> Add Item
                    </button>
                </div>

                <!-- Budget Item Form (hidden by default) -->
                <form id="budgetItemForm" class="budget-form" style="display: none;">
                    <input type="hidden" id="budgetItemId">
                    <input type="hidden" id="budgetProjectId">
                    
                    <div class="form-group">
                        <label for="itemName">Item Name*</label>
                        <input type="text" id="itemName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="itemCategory">Category*</label>
                        <select id="itemCategory" required>
                            <option value="">Select Category</option>
                            <option value="Personnel">Personnel</option>
                            <option value="Equipment">Equipment</option>
                            <option value="Materials">Materials</option>
                            <option value="Travel">Travel</option>
                            <option value="Training">Training</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="itemQuantity">Quantity*</label>
                        <input type="number" id="itemQuantity" min="0" step="1" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="itemUnitPrice">Unit Price (UGX)*</label>
                        <input type="number" id="itemUnitPrice" min="0" step="1000" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="itemDescription">Description</label>
                        <input type="text" id="itemDescription">
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelBudgetItemBtn">Cancel</button>
                        <button type="button" class="btn" id="saveBudgetItemBtn">Save Item</button>
                    </div>
                </form>

                <!-- Budget Items Table -->
                <div class="table-responsive">
                    <table class="budget-table" id="budgetTable">
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th>Category</th>
                                <th>Quantity</th>
                                <th>Unit Price (UGX)</th>
                                <th>Total (UGX)</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="budgetTableBody">
                            <!-- Budget items will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="budget-total" id="budgetTotal">
                    Total Budget: UGX 0
                </div>
            </div>
        </main>
    </div>

    <!-- Previous modals remain the same -->

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Previous DOM elements and variables
            const budgetSection = document.getElementById('budgetSection');
            const addBudgetItemBtn = document.getElementById('addBudgetItemBtn');
            const budgetItemForm = document.getElementById('budgetItemForm');
            const budgetTableBody = document.getElementById('budgetTableBody');
            const saveBudgetItemBtn = document.getElementById('saveBudgetItemBtn');
            const cancelBudgetItemBtn = document.getElementById('cancelBudgetItemBtn');
            const budgetTotal = document.getElementById('budgetTotal');
            
            // New variables
            let currentBudgetProjectId = null;
            let isEditBudgetMode = false;

            // New event listeners
            addBudgetItemBtn.addEventListener('click', showBudgetItemForm);
            cancelBudgetItemBtn.addEventListener('click', hideBudgetItemForm);
            saveBudgetItemBtn.addEventListener('click', saveBudgetItem);
            
            // New functions for budget management
            function showBudgetSection(projectId) {
                currentBudgetProjectId = projectId;
                budgetSection.style.display = 'block';
                document.getElementById('budgetProjectId').value = projectId;
                loadBudgetItems(projectId);
            }

            function hideBudgetSection() {
                budgetSection.style.display = 'none';
                currentBudgetProjectId = null;
                budgetTableBody.innerHTML = '';
            }

            function showBudgetItemForm() {
                budgetItemForm.style.display = 'flex';
                budgetItemForm.reset();
                document.getElementById('budgetItemId').value = '';
                isEditBudgetMode = false;
            }

            function hideBudgetItemForm() {
                budgetItemForm.style.display = 'none';
            }

            function loadBudgetItems(projectId) {
                budgetTableBody.innerHTML = '<tr><td colspan="7" class="loading"><i class="fas fa-spinner"></i> Loading budget items...</td></tr>';
                
                fetch(`https://man-m681.onrender.com/budget-items/${projectId}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to fetch budget items');
                        return response.json();
                    })
                    .then(items => {
                        budgetTableBody.innerHTML = '';
                        
                        if (items.length === 0) {
                            budgetTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No budget items found</td></tr>';
                            budgetTotal.textContent = 'Total Budget: UGX 0';
                            return;
                        }
                        
                        let totalBudget = 0;
                        
                        items.forEach(item => {
                            totalBudget += item.total;
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${item.item_name}</td>
                                <td>${item.category}</td>
                                <td>${item.quantity}</td>
                                <td>${item.unit_price.toLocaleString()}</td>
                                <td>${item.total.toLocaleString()}</td>
                                <td>${item.description || '-'}</td>
                                <td>
                                    <button class="action-btn edit-btn" onclick="editBudgetItem(${item.id}, '${item.item_name}', '${item.category}', ${item.quantity}, ${item.unit_price}, '${item.description || ''}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="action-btn delete-btn" onclick="deleteBudgetItem(${item.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                            budgetTableBody.appendChild(row);
                        });
                        
                        budgetTotal.textContent = `Total Budget: UGX ${totalBudget.toLocaleString()}`;
                    })
                    .catch(error => {
                        console.error('Error loading budget items:', error);
                        budgetTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--accent-color);">Failed to load budget items</td></tr>';
                    });
            }

            function saveBudgetItem() {
                const itemData = {
                    project_id: parseInt(document.getElementById('budgetProjectId').value),
                    item_name: document.getElementById('itemName').value,
                    category: document.getElementById('itemCategory').value,
                    quantity: parseFloat(document.getElementById('itemQuantity').value),
                    unit_price: parseFloat(document.getElementById('itemUnitPrice').value),
                    description: document.getElementById('itemDescription').value
                };

                // Simple validation
                if (!itemData.item_name || !itemData.category || isNaN(itemData.quantity) || isNaN(itemData.unit_price)) {
                    alert('Please fill all required fields with valid values');
                    return;
                }

                const itemId = document.getElementById('budgetItemId').value;
                const url = itemId 
                    ? `https://man-m681.onrender.com/budget-items/${itemId}`
                    : 'https://man-m681.onrender.com/budget-items/';
                
                const method = itemId ? 'PUT' : 'POST';

                // Show loading state
                const originalText = saveBudgetItemBtn.innerHTML;
                saveBudgetItemBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                saveBudgetItemBtn.disabled = true;

                fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(itemData)
                })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to save budget item');
                    return response.json();
                })
                .then(() => {
                    hideBudgetItemForm();
                    loadBudgetItems(currentBudgetProjectId);
                })
                .catch(error => {
                    console.error('Error saving budget item:', error);
                    alert('Failed to save budget item: ' + error.message);
                })
                .finally(() => {
                    saveBudgetItemBtn.innerHTML = originalText;
                    saveBudgetItemBtn.disabled = false;
                });
            }

            function editBudgetItem(id, name, category, quantity, unitPrice, description) {
                document.getElementById('budgetItemId').value = id;
                document.getElementById('itemName').value = name;
                document.getElementById('itemCategory').value = category;
                document.getElementById('itemQuantity').value = quantity;
                document.getElementById('itemUnitPrice').value = unitPrice;
                document.getElementById('itemDescription').value = description;
                
                isEditBudgetMode = true;
                budgetItemForm.style.display = 'flex';
            }

            function deleteBudgetItem(id) {
                if (!confirm('Are you sure you want to delete this budget item?')) {
                    return;
                }
                
                fetch(`https://man-m681.onrender.com/budget-items/${id}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to delete budget item');
                    return response.json();
                })
                .then(() => {
                    loadBudgetItems(currentBudgetProjectId);
                })
                .catch(error => {
                    console.error('Error deleting budget item:', error);
                    alert('Failed to delete budget item');
                });
            }

            // Update viewProject function to show budget section
            function viewProject(projectId) {
                showBudgetSection(projectId);
                
                // Scroll to budget section
                budgetSection.scrollIntoView({ behavior: 'smooth' });
            }

            // Make functions available globally
            window.editBudgetItem = editBudgetItem;
            window.deleteBudgetItem = deleteBudgetItem;
            window.viewProject = viewProject;
        });
    </script>
</body>
</html>
