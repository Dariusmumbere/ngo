<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Management | RCDNET</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Previous styles remain the same, add these new styles */

        /* Budget Section Styles */
        .budget-section {
            margin-top: 30px;
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .budget-items-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 15px;
        }

        .budget-items-table th, 
        .budget-items-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        .budget-items-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #555;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }

        .budget-items-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .budget-items-table tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }

        .budget-summary {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            font-weight: 600;
        }

        .budget-total {
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        /* Budget Item Modal */
        .budget-item-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .budget-item-modal.show {
            opacity: 1;
            visibility: visible;
        }

        /* Small badge for categories */
        .category-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            background-color: #e0f2fe;
            color: #0369a1;
        }

        /* Input group for quantity and unit price */
        .input-group {
            display: flex;
            gap: 10px;
        }

        .input-group .form-group {
            flex: 1;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .budget-items-table th, 
            .budget-items-table td {
                padding: 8px;
                font-size: 0.8rem;
            }
            
            .input-group {
                flex-direction: column;
                gap: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <main class="main-content">
            <h1 class="page-title">
                <i class="fas fa-project-diagram"></i>
                Project Management
            </h1>

            <div class="projects-container">
                <div class="section-header">
                    <h2 class="section-title">Current Projects</h2>
                    <div class="section-actions">
                        <button class="btn" id="createProjectBtn">
                            <i class="fas fa-plus"></i> New Project
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="projects-table" id="projectsTable">
                        <thead>
                            <tr>
                                <th>Program Area</th>
                                <th>Project Name</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Budget (UGX)</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="projectsTableBody">
                            <!-- Projects will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Budget Section (shown when a project is selected) -->
            <div class="budget-section" id="budgetSection" style="display: none;">
                <div class="section-header">
                    <h2 class="section-title">Project Budget</h2>
                    <div class="section-actions">
                        <button class="btn" id="addBudgetItemBtn">
                            <i class="fas fa-plus"></i> Add Budget Item
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="budget-items-table" id="budgetItemsTable">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Unit Price (UGX)</th>
                                <th>Total (UGX)</th>
                                <th>Category</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="budgetItemsTableBody">
                            <!-- Budget items will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <div class="budget-summary">
                    <span>Total Budget:</span>
                    <span class="budget-total" id="budgetTotal">UGX 0</span>
                </div>
            </div>
        </main>
    </div>

    <!-- Create/Edit Project Modal -->
    <div class="project-modal" id="projectModal">
        <!-- Existing project modal content remains the same -->
    </div>

    <!-- Budget Item Modal -->
    <div class="budget-item-modal" id="budgetItemModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="budgetModalTitle">Add Budget Item</h3>
                <button class="close-btn" id="closeBudgetModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="budgetItemForm">
                    <input type="hidden" id="budgetItemId">
                    <input type="hidden" id="budgetProjectId">
                    
                    <div class="form-group">
                        <label for="itemName">Item Name*</label>
                        <input type="text" id="itemName" required>
                        <div class="validation-error" id="itemNameError">Please enter an item name</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="itemDescription">Description</label>
                        <textarea id="itemDescription"></textarea>
                    </div>
                    
                    <div class="input-group">
                        <div class="form-group">
                            <label for="itemQuantity">Quantity*</label>
                            <input type="number" id="itemQuantity" min="1" required>
                            <div class="validation-error" id="itemQuantityError">Please enter a valid quantity</div>
                        </div>
                        <div class="form-group">
                            <label for="itemUnitPrice">Unit Price (UGX)*</label>
                            <input type="number" id="itemUnitPrice" min="0" step="100" required>
                            <div class="validation-error" id="itemUnitPriceError">Please enter a valid unit price</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="itemCategory">Category*</label>
                        <select id="itemCategory" required>
                            <option value="">Select Category</option>
                            <option value="Personnel">Personnel</option>
                            <option value="Equipment">Equipment</option>
                            <option value="Materials">Materials</option>
                            <option value="Travel">Travel</option>
                            <option value="Training">Training</option>
                            <option value="Administrative">Administrative</option>
                            <option value="Other">Other</option>
                        </select>
                        <div class="validation-error" id="itemCategoryError">Please select a category</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelBudgetBtn">Cancel</button>
                <button class="btn" id="saveBudgetItemBtn">Save Item</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const createProjectBtn = document.getElementById('createProjectBtn');
            const projectModal = document.getElementById('projectModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const saveProjectBtn = document.getElementById('saveProjectBtn');
            const projectForm = document.getElementById('projectForm');
            const projectsTableBody = document.getElementById('projectsTableBody');
            const modalTitle = document.getElementById('modalTitle');
            
            // Budget elements
            const budgetSection = document.getElementById('budgetSection');
            const budgetItemsTableBody = document.getElementById('budgetItemsTableBody');
            const budgetTotal = document.getElementById('budgetTotal');
            const addBudgetItemBtn = document.getElementById('addBudgetItemBtn');
            const budgetItemModal = document.getElementById('budgetItemModal');
            const closeBudgetModalBtn = document.getElementById('closeBudgetModalBtn');
            const cancelBudgetBtn = document.getElementById('cancelBudgetBtn');
            const saveBudgetItemBtn = document.getElementById('saveBudgetItemBtn');
            const budgetItemForm = document.getElementById('budgetItemForm');
            const budgetModalTitle = document.getElementById('budgetModalTitle');
            
            // Variables
            let currentProjectId = null;
            let currentBudgetItemId = null;
            let isEditMode = false;
            let isBudgetEditMode = false;

            // Event Listeners
            createProjectBtn.addEventListener('click', openCreateProjectModal);
            closeModalBtn.addEventListener('click', closeProjectModal);
            cancelBtn.addEventListener('click', closeProjectModal);
            saveProjectBtn.addEventListener('click', saveProject);
            
            addBudgetItemBtn.addEventListener('click', openCreateBudgetItemModal);
            closeBudgetModalBtn.addEventListener('click', closeBudgetItemModal);
            cancelBudgetBtn.addEventListener('click', closeBudgetItemModal);
            saveBudgetItemBtn.addEventListener('click', saveBudgetItem);
            
            // Form validation
            projectForm.addEventListener('submit', function(e) {
                e.preventDefault();
                saveProject();
            });

            budgetItemForm.addEventListener('submit', function(e) {
                e.preventDefault();
                saveBudgetItem();
            });

            // Initialize the page
            loadProjects();

            // Functions
            function openCreateProjectModal() {
                currentProjectId = null;
                isEditMode = false;
                modalTitle.textContent = 'Create New Project';
                projectForm.reset();
                document.getElementById('projectStatus').value = 'planned';
                openProjectModal();
            }

            function openEditProjectModal(projectId) {
                currentProjectId = projectId;
                isEditMode = true;
                modalTitle.textContent = 'Edit Project';
                
                // Fetch project data and populate form
                fetch(`https://man-m681.onrender.com/projects/${projectId}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to fetch project');
                        return response.json();
                    })
                    .then(project => {
                        document.getElementById('programArea').value = project.name.includes('Women') ? 'Women Empowerment' : 
                                                                     project.name.includes('Vocational') ? 'Vocational Education' :
                                                                     project.name.includes('Climate') ? 'Climate Change Mitigation' :
                                                                     project.name.includes('Reproductive') ? 'Reproductive Health' :
                                                                     project.name.includes('Agriculture') ? 'Agriculture Extension' :
                                                                     project.name.includes('Economic') ? 'Economic Empowerment' : '';
                        document.getElementById('projectName').value = project.name;
                        document.getElementById('startDate').value = project.start_date;
                        document.getElementById('endDate').value = project.end_date;
                        document.getElementById('scopeStatement').value = project.description || '';
                        document.getElementById('budget').value = project.budget;
                        document.getElementById('fundingSource').value = project.funding_source;
                        document.getElementById('projectStatus').value = project.status;
                    })
                    .catch(error => {
                        console.error('Error loading project:', error);
                        alert('Failed to load project data');
                    });
                
                openProjectModal();
            }

            function openProjectModal() {
                projectModal.classList.add('show');
            }

            function closeProjectModal() {
                projectModal.classList.remove('show');
                resetValidationErrors();
            }

            function resetValidationErrors() {
                document.querySelectorAll('.validation-error').forEach(el => {
                    el.style.display = 'none';
                });
            }

            function validateForm() {
                let isValid = true;
                resetValidationErrors();

                const requiredFields = [
                    { id: 'programArea', errorId: 'programAreaError' },
                    { id: 'projectName', errorId: 'projectNameError' },
                    { id: 'startDate', errorId: 'startDateError' },
                    { id: 'endDate', errorId: 'endDateError' },
                    { id: 'scopeStatement', errorId: 'scopeStatementError' },
                    { id: 'budget', errorId: 'budgetError' }
                ];

                requiredFields.forEach(field => {
                    const element = document.getElementById(field.id);
                    if (!element.value.trim()) {
                        document.getElementById(field.errorId).style.display = 'block';
                        element.style.borderColor = 'var(--accent-color)';
                        isValid = false;
                        
                        // Focus on first invalid field
                        if (isValid === false) {
                            element.focus();
                            isValid = null; // Prevent changing back to true
                        }
                    } else {
                        element.style.borderColor = '';
                    }
                });

                // Validate dates
                const startDate = new Date(document.getElementById('startDate').value);
                const endDate = new Date(document.getElementById('endDate').value);
                
                if (startDate && endDate && startDate > endDate) {
                    document.getElementById('endDateError').textContent = 'End date must be after start date';
                    document.getElementById('endDateError').style.display = 'block';
                    document.getElementById('endDate').style.borderColor = 'var(--accent-color)';
                    isValid = false;
                }

                return isValid;
            }

            function saveProject() {
                if (validateForm() !== true) return;
                
                const projectData = {
                    name: `${document.getElementById('programArea').value} - ${document.getElementById('projectName').value}`,
                    description: document.getElementById('scopeStatement').value,
                    start_date: document.getElementById('startDate').value,
                    end_date: document.getElementById('endDate').value,
                    budget: parseFloat(document.getElementById('budget').value),
                    funding_source: document.getElementById('fundingSource').value,
                    status: document.getElementById('projectStatus').value
                };

                const url = isEditMode 
                    ? `https://man-m681.onrender.com/projects/${currentProjectId}`
                    : 'https://man-m681.onrender.com/projects/';
                
                const method = isEditMode ? 'PUT' : 'POST';

                // Show loading state
                const originalText = saveProjectBtn.innerHTML;
                saveProjectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                saveProjectBtn.disabled = true;

                fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(projectData)
                })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to save project');
                    return response.json();
                })
                .then((savedProject) => {
                    closeProjectModal();
                    loadProjects();
                    // If this was a new project, show its budget section
                    if (!isEditMode) {
                        showProjectBudget(savedProject.id);
                    }
                })
                .catch(error => {
                    console.error('Error saving project:', error);
                    alert('Failed to save project: ' + error.message);
                })
                .finally(() => {
                    saveProjectBtn.innerHTML = originalText;
                    saveProjectBtn.disabled = false;
                });
            }

            function loadProjects() {
                projectsTableBody.innerHTML = '<tr><td colspan="7" class="loading"><i class="fas fa-spinner"></i> Loading projects...</td></tr>';
                
                fetch('https://man-m681.onrender.com/projects/')
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to fetch projects');
                        return response.json();
                    })
                    .then(data => {
                        projectsTableBody.innerHTML = '';
                        
                        if (data.projects && data.projects.length === 0) {
                            projectsTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No projects found</td></tr>';
                            return;
                        }
                        
                        data.projects.forEach(project => {
                            // Extract program area from project name
                            const programArea = project.name.split(' - ')[0] || 'General';
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${programArea}</td>
                                <td>${project.name.split(' - ')[1] || project.name}</td>
                                <td>${project.start_date}</td>
                                <td>${project.end_date}</td>
                                <td>${project.budget.toLocaleString()}</td>
                                <td><span class="status-badge ${project.status}">${project.status.replace('_', ' ')}</span></td>
                                <td>
                                    <button class="action-btn view-btn" onclick="viewProject(${project.id})">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="action-btn edit-btn" onclick="openEditProjectModal(${project.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="action-btn delete-btn" onclick="deleteProject(${project.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <button class="action-btn budget-btn" onclick="showProjectBudget(${project.id})" title="View Budget">
                                        <i class="fas fa-money-bill-wave"></i>
                                    </button>
                                </td>
                            `;
                            projectsTableBody.appendChild(row);
                        });
                    })
                    .catch(error => {
                        console.error('Error loading projects:', error);
                        projectsTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--accent-color);">Failed to load projects</td></tr>';
                    });
            }

            function showProjectBudget(projectId) {
                currentProjectId = projectId;
                budgetSection.style.display = 'block';
                loadBudgetItems(projectId);
                
                // Scroll to budget section
                budgetSection.scrollIntoView({ behavior: 'smooth' });
            }

            function loadBudgetItems(projectId) {
                budgetItemsTableBody.innerHTML = '<tr><td colspan="7" class="loading"><i class="fas fa-spinner"></i> Loading budget items...</td></tr>';
                
                fetch(`https://man-m681.onrender.com/projects/${projectId}/budget`)
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to fetch budget items');
                        return response.json();
                    })
                    .then(data => {
                        budgetItemsTableBody.innerHTML = '';
                        
                        if (data.budget_items && data.budget_items.length === 0) {
                            budgetItemsTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No budget items found</td></tr>';
                            budgetTotal.textContent = 'UGX 0';
                            return;
                        }
                        
                        let totalBudget = 0;
                        
                        data.budget_items.forEach(item => {
                            totalBudget += item.total;
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${item.item_name}</td>
                                <td>${item.description || '-'}</td>
                                <td>${item.quantity}</td>
                                <td>${item.unit_price.toLocaleString()}</td>
                                <td>${item.total.toLocaleString()}</td>
                                <td><span class="category-badge">${item.category}</span></td>
                                <td>
                                    <button class="action-btn edit-btn" onclick="openEditBudgetItemModal(${item.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="action-btn delete-btn" onclick="deleteBudgetItem(${item.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                            budgetItemsTableBody.appendChild(row);
                        });
                        
                        budgetTotal.textContent = `UGX ${totalBudget.toLocaleString()}`;
                    })
                    .catch(error => {
                        console.error('Error loading budget items:', error);
                        budgetItemsTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--accent-color);">Failed to load budget items</td></tr>';
                    });
            }

            function openCreateBudgetItemModal() {
                if (!currentProjectId) return;
                
                currentBudgetItemId = null;
                isBudgetEditMode = false;
                budgetModalTitle.textContent = 'Add Budget Item';
                budgetItemForm.reset();
                document.getElementById('budgetProjectId').value = currentProjectId;
                openBudgetItemModal();
            }

            function openEditBudgetItemModal(itemId) {
                currentBudgetItemId = itemId;
                isBudgetEditMode = true;
                budgetModalTitle.textContent = 'Edit Budget Item';
                
                fetch(`https://man-m681.onrender.com/budget-items/${itemId}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to fetch budget item');
                        return response.json();
                    })
                    .then(item => {
                        document.getElementById('budgetProjectId').value = item.project_id;
                        document.getElementById('itemName').value = item.item_name;
                        document.getElementById('itemDescription').value = item.description || '';
                        document.getElementById('itemQuantity').value = item.quantity;
                        document.getElementById('itemUnitPrice').value = item.unit_price;
                        document.getElementById('itemCategory').value = item.category;
                    })
                    .catch(error => {
                        console.error('Error loading budget item:', error);
                        alert('Failed to load budget item data');
                    });
                
                openBudgetItemModal();
            }

            function openBudgetItemModal() {
                budgetItemModal.classList.add('show');
            }

            function closeBudgetItemModal() {
                budgetItemModal.classList.remove('show');
                resetBudgetValidationErrors();
            }

            function resetBudgetValidationErrors() {
                const fields = ['itemName', 'itemQuantity', 'itemUnitPrice', 'itemCategory'];
                fields.forEach(field => {
                    document.getElementById(`${field}Error`).style.display = 'none';
                    document.getElementById(field).style.borderColor = '';
                });
            }

            function validateBudgetForm() {
                let isValid = true;
                resetBudgetValidationErrors();

                const requiredFields = [
                    { id: 'itemName', errorId: 'itemNameError' },
                    { id: 'itemQuantity', errorId: 'itemQuantityError' },
                    { id: 'itemUnitPrice', errorId: 'itemUnitPriceError' },
                    { id: 'itemCategory', errorId: 'itemCategoryError' }
                ];

                requiredFields.forEach(field => {
                    const element = document.getElementById(field.id);
                    if (!element.value.trim()) {
                        document.getElementById(field.errorId).style.display = 'block';
                        element.style.borderColor = 'var(--accent-color)';
                        isValid = false;
                        
                        // Focus on first invalid field
                        if (isValid === false) {
                            element.focus();
                            isValid = null; // Prevent changing back to true
                        }
                    } else {
                        element.style.borderColor = '';
                    }
                });

                return isValid;
            }

            function saveBudgetItem() {
                if (validateBudgetForm() !== true) return;
                
                const projectId = document.getElementById('budgetProjectId').value;
                const itemData = {
                    project_id: parseInt(projectId),
                    item_name: document.getElementById('itemName').value,
                    description: document.getElementById('itemDescription').value,
                    quantity: parseInt(document.getElementById('itemQuantity').value),
                    unit_price: parseFloat(document.getElementById('itemUnitPrice').value),
                    category: document.getElementById('itemCategory').value
                };

                const url = isBudgetEditMode 
                    ? `https://man-m681.onrender.com/budget-items/${currentBudgetItemId}`
                    : 'https://man-m681.onrender.com/budget-items/';
                
                const method = isBudgetEditMode ? 'PUT' : 'POST';

                // Show loading state
                const originalText = saveBudgetItemBtn.innerHTML;
                saveBudgetItemBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                saveBudgetItemBtn.disabled = true;

                fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(itemData)
                })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to save budget item');
                    return response.json();
                })
                .then(() => {
                    closeBudgetItemModal();
                    loadBudgetItems(projectId);
                })
                .catch(error => {
                    console.error('Error saving budget item:', error);
                    alert('Failed to save budget item: ' + error.message);
                })
                .finally(() => {
                    saveBudgetItemBtn.innerHTML = originalText;
                    saveBudgetItemBtn.disabled = false;
                });
            }

            function deleteBudgetItem(itemId) {
                if (!confirm('Are you sure you want to delete this budget item? This action cannot be undone.')) {
                    return;
                }
                
                fetch(`https://man-m681.onrender.com/budget-items/${itemId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to delete budget item');
                    return response.json();
                })
                .then(() => {
                    loadBudgetItems(currentProjectId);
                })
                .catch(error => {
                    console.error('Error deleting budget item:', error);
                    alert('Failed to delete budget item');
                });
            }

            function viewProject(projectId) {
                fetch(`https://man-m681.onrender.com/projects/${projectId}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Failed to fetch project');
                        return response.json();
                    })
                    .then(project => {
                        // Extract program area from project name
                        const programArea = project.name.split(' - ')[0] || 'General';
                        const projectName = project.name.split(' - ')[1] || project.name;
                        
                        alert(`Project Details:\n\n` +
                              `Program Area: ${programArea}\n` +
                              `Project Name: ${projectName}\n` +
                              `Start Date: ${project.start_date}\n` +
                              `End Date: ${project.end_date}\n` +
                              `Budget: UGX ${project.budget.toLocaleString()}\n` +
                              `Status: ${project.status}\n` +
                              `Scope: ${project.description || 'Not specified'}`);
                    })
                    .catch(error => {
                        console.error('Error viewing project:', error);
                        alert('Failed to view project details');
                    });
            }

            function deleteProject(projectId) {
                if (!confirm('Are you sure you want to delete this project and all its budget items? This action cannot be undone.')) {
                    return;
                }
                
                fetch(`https://man-m681.onrender.com/projects/${projectId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to delete project');
                    return response.json();
                })
                .then(() => {
                    loadProjects();
                    budgetSection.style.display = 'none';
                })
                .catch(error => {
                    console.error('Error deleting project:', error);
                    alert('Failed to delete project');
                });
            }

            // Make functions available globally for onclick attributes
            window.viewProject = viewProject;
            window.openEditProjectModal = openEditProjectModal;
            window.deleteProject = deleteProject;
            window.showProjectBudget = showProjectBudget;
            window.openEditBudgetItemModal = openEditBudgetItemModal;
            window.deleteBudgetItem = deleteBudgetItem;
        });
    </script>
</body>
</html>
